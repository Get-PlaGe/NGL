<?xml version="1.0" encoding="UTF-8"?>
	
<Specification xmlns="http://www.genoscope.cns.fr/specification"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.genoscope.cns.fr/specification
H:\birdsSpec.xsd">

	<!-- Group treatment for submission -->
	<Treatment name="WF_Submission" checkIfNewTreatmentAlreadyPerformed="true" ruleFlowId="fr.cea.ig.auto.submission.WorkflowSubmission">
		<ExecutableSpecification>
			<Executable />
		</ExecutableSpecification>
		<ParametersSpecification />
		<InputsSpecification>
			<InputElement name="subData" count="1" resourceType="submission">
				<Referential name="nglSubRef" />			
			</InputElement>
		</InputsSpecification>
	</Treatment>
	<!-- Treatment for generate zip archive for each rawData -->
	<Treatment name="zip" useJobScheduler="true" checkIfNewTreatmentAlreadyPerformed="true" >
		<ExecutableSpecification commandSyntaxStrategyName="zipSyntax">
			<Executable path="gzip" />
			<Lsf job="zip" queue="big"/>
		</ExecutableSpecification>
		<ParametersSpecification>
			<LineElement line="-c" parameterName="tostdout" />
			<LineElement line="%fileNameToZip%" parameterName="fileNameToZip" />
			<LineElement line="%fileNameZiped%" parameterName="fileNameZiped" />
		</ParametersSpecification>
		<InputsSpecification>
			<InputElement name="rawDataFile" count="1" resourceType="rawData">
				<Referential name="internalRefSubmission"/>
			</InputElement>
		</InputsSpecification>
		<OutputsSpecification>
			<OutputElement name="rawDataZip" resourceType="rawData">
				<Referential name="internalRefRawData"/>
			</OutputElement>
		</OutputsSpecification>
	</Treatment>
	
	<!-- Treatment for md5 File -->
	<Treatment name="md5" useJobScheduler="true" checkIfNewTreatmentAlreadyPerformed="true">
		<ExecutableSpecification commandSyntaxStrategyName="md5Syntax">
			<Executable path="md5sum"/>
			<Lsf job="md5Job" queue="big" />
		</ExecutableSpecification>
		<ParametersSpecification>
			<LineElement line="%fileNameToMd5%" parameterName="fileNameToMd5" />
			<LineElement line="%md5File%" parameterName="md5File" />
		</ParametersSpecification>
		<InputsSpecification>
			<InputElement name="zipDataFile" count="1" resourceType="rawData">
				<Referential name="internalRefRawData" />
			</InputElement>
		</InputsSpecification>
	</Treatment>
	
	<!-- Treatment for file transfert  -->
	<Treatment name="ftp" useJobScheduler="true" checkIfNewTreatmentAlreadyPerformed="true">
	
		<!-- TODO voir si on veut nommer les jobs spÃ©cifiquement -->
		<ExecutableSpecification commandSyntaxStrategyName="ncftpputSyntax">
			<Executable path="ncftpput"/>
			<Lsf job="ftpJob" queue="big" />
		</ExecutableSpecification>
		
		<ParametersSpecification>
			<KeyValueElement key="-u" value="era-drop-9" parameterName="userEBI"/>
			<KeyValueElement key="-p" value="Axqw16nI" parameterName="pwdEBI"/>
			<KeyValueElement key="-t" value="60" parameterName="timeOut"/>
			<KeyValueElement key="-V" value="ftp.sra.ebi.ac.uk" parameterName="remoteHost"/>
			<LineElement line="-R" parameterName="recursif"/>
			<LineElement line="/" parameterName="remotePath"/>
			<LineElement line="%directoryPath%" parameterName="localDirectoryPath"/>
		</ParametersSpecification>
		
		<InputsSpecification>
			<InputElement name="rawDataDir" count="1" resourceType="submission">
				<Referential name="internalRefSubmission"/>
			</InputElement>
		</InputsSpecification>
		
	</Treatment>
	
	<!-- Treatment : call NGL SUB services to create xml files to send to EBI -->
	<Treatment name="createXML" useJobScheduler="false" checkIfNewTreatmentAlreadyPerformed="true">
		<ExecutableSpecification commandSyntaxStrategyName="createXMLSyntax">
			<!-- TODO call REST API NGL-SUB -->
			<Executable path="curl http://appprod.genoscope.cns.fr:90??/api/submissions/"/>
		</ExecutableSpecification>
		
		<ParametersSpecification>
			<LineElement line="%subCode%" parameterName="subCode" />
		</ParametersSpecification>
		
		<InputsSpecification>
			<InputElement name="subToXML" count="1" resourceType="submission">
				<Referential name="internalRefSubmission"/>
			</InputElement>
		</InputsSpecification>
	</Treatment>
	
	<!-- Treatment : call EBI services to send xml files -->
	<Treatment name="sendXML" useJobScheduler="false" checkIfNewTreatmentAlreadyPerformed="true">
		<ExecutableSpecification commandSyntaxStrategyName="sendXMLSyntax">
			<Executable path="curl https://www.ebi.ac.uk/ena/submit/drop-box/submit/?auth=ERA%20era-drop-9%20N7mo%2B8F4aHH%2BrCjLTuMo59xwfFo%3D" />
		</ExecutableSpecification>
		<ParametersSpecification>
			<KeyValueElement key="-F" value="&quot;SUBMISSION=@%submissionXML%&quot;" parameterName="submissionXML"/>
			<KeyValueElement key="-F" value="&quot;STUDY=@%studyXML%&quot;" parameterName="studyXML"/>
			<KeyValueElement key="-F" value="&quot;SAMPLE=@%sampleXML%&quot;" parameterName="sampleXML"/>
			<KeyValueElement key="-F" value="&quot;EXPERIMENT=@%experimentXML%&quot;" parameterName="experimentXML"/>
			<KeyValueElement key="-F" value="&quot;RUN=@%runXML%&quot;" parameterName="runXML"/>
			<LineElement line="-k" parameterName="optK" />
		</ParametersSpecification>
		<InputsSpecification>
			<InputElement name="subToSend" count="1" resourceType="submission">
				<Referential name="internalRefSubmission" />
			</InputElement>
		</InputsSpecification>
	</Treatment>
</Specification>
