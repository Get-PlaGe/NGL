@(currentUser:java.lang.String)

@import views.html.helper._
@import views.html.experiments.partials._


@imageModal()
@finishStepModal()


<div class="row">
<div class="col-md-10 col-lg-10 " style="position:fixed;background-color:white;z-index:100;top: 30px;">
	<div class="page-header">
	<div class="btn-toolbar" style="float:right;width:600px">
			<button class="btn btn-default" ng-if="doneAndRecorded==false" ng-click="edit()" ng-show="editMode==false" data-toggle="tooltip" title="@Messages("experiments.edit")"><i class="fa fa-edit"></i></button>
			<button class="btn btn-default" ng-if="doneAndRecorded==false" ng-click="unedit()" ng-show="editMode==true" data-toggle="tooltip" title="@Messages("experiments.unedit")"><i class="fa fa-undo"></i></button>	
				  			
			<button class="btn btn-default" ng-show="experiment.value.state.code == 'N'" ng-disabled="experiment.value._id == null" ng-click="saveAllAndChangeState()" >@Messages("experiments.begin_progress")</button>
			<button  class="btn btn-default"  ng-show="experiment.value.state.code == 'IP'" ng-disabled="experiment.value._id == null" ng-click="finishExperiment()" >@Messages("experiments.finish")</button>
		<div class="btn-group " id="experiment_action">
			<a class="btn btn-default dropdown-toggle" data-toggle="dropdown"> Actions <span
				class="caret"></span>
			</a>
			<ul class="dropdown-menu dropdown-menu-right">
				<li><a href="#" ng-disabled="experiment.value.stateCode != 'IP'"  ng-click="generateSampleSheet()" >@Messages("experiments.sampleSheet")</a></li>
			</ul>
		</div>
		<button class="btn btn-primary" ng-disabled="saveInProgress == true" ng-click="saveAllPromise();" data-toggle="tooltip"  title="@Messages("experiments.save_all")">
			<i class="fa fa-save"></i>
		</button>
		<button class="btn btn-default"  ng-disabled="experiment.value._id == null"  ng-click="experiment.comment = {}" data-toggle="modal" data-target="#myModal">@Messages("experiment.addComment")</button>
		
										
	</div>
	<h1>{{experiment.value.code || '@Messages("experiments.noCode")'}}</h1>
	</div>
	</div>
</div>
<div class="row">
<div class="col-md-12 col-lg-12" style="position:fixed;margin-top: 80px;z-index:101;">
<div ng-class="message.clazz" ng-show="message.text !== undefined">
	<strong>{{message.text}}</strong><button class="btn btn-link" ng-click="message.showDetails=!message.showDetails" ng-show="message.isDetails">@(Messages("experiments.msg.details"))</button>
	<div ng-show="message.showDetails">
	    <ul>
    		<li ng-repeat="(key1, value1) in message.details">{{key1}}
    		<ul>
    			<li ng-repeat="(key2, value2) in value1 | unique"> {{value2}} </li>
    		</ul>
    		</li>
    	</ul>	
	</div>
</div>
</div>
</div>

<div class="row" style="margin-top: 135px;">
		<div class="col-md-12 col-lg-12">
		<div class="inProgressSpinner" ng-if="spinnerStart==true"><button class="spinnerBtn btn btn-primary btn-lg"><i class="fa fa-spinner fa-spin fa-5x"></i></button></div>
		<div class="row">
			<div class="col-md-5 col-lg-5">
			  <div class="panel panel-default">
			  <div class="panel-heading">
			  	<div class="btn-group pull-right" ng-switch on="experiment.experimentInformation.enabled" >
						<button class="btn btn-default btn-xs" ng-click="experiment.experimentInformation.toggleEdit()" ng-switch-when="false" data-toggle="tooltip" title="@Messages("experiments.edit")"><i class="fa fa-edit"></i></button>
						<button class="btn btn-default btn-xs" ng-click="experiment.experimentInformation.toggleEdit()" ng-switch-when="true" data-toggle="tooltip" title="@Messages("experiments.unedit")"><i class="fa fa-undo"></i></button>	
				  </div>
				  <h2 class="panel-title">Exp&eacute;rience</h2>			  	
			  </div>
			  <div class="panel-body">
			    <form class="form-horizontal">
					@columnLabelValue(Messages("experiments.type")){
						<p class="form-control-static">{{experiment.value.typeCode | codes:'type'}}</p>
					}			    
					@columnLabelValue(Messages("experiments.protocol")){
					<div ng-switch on="doneAndRecorded">						
						<p ng-switch-when="true" class="form-control-static" ng-model='experiment.value.protocolCode'>
						 {{experiment.value.protocolCode | codes:'protocol'}} </p>
						<div ng-switch-when="false">
							<div bt-select class="form-control"
								ng-model="experiment.value.protocolCode"
								ng-readonly="!experiment.experimentInformation.enabled"
								bt-options="protocol.code as protocol.name for protocol in lists.get('protocols')"
								ng-disabled="!experiment.experimentInformation.enabled"
								auto-select>
							</div>
						</div>
					</div>
					}	
			   	 	@columnLabelValue(Messages("experiments.state")){
			   	 		<p class="form-control-static">{{experiment.value.state.code | codes:'state'}}</p>
					}
					
					
			    	@columnLabelValue(Messages("experiments.resolution")){
							<div bt-select class="form-control" ng-model="experiment.value.state.resolutionCodes" multiple="true"
							ng-readonly="!experiment.experimentInformation.enabled"  ng-disabled="!experiment.experimentInformation.enabled"
							placeholder="@Messages("experiments.select.resolutions")" bt-options="valid.code as valid.name for valid in lists.getResolutions()" ng-edit="!doneAndRecorded || experiment.experimentInformation.enabled "></div>							
						
					}	
					
					<!-- Properties Experiment  -->
					<div class="form-group" ng-repeat="expp in experiment.experimentProperties.inputs" ng-if="getLevel(expp.levels,'Experiment')">									
						<label  class="col-md-6 col-lg-6 control-label">{{expp.name}}</label>
						
						
						
						<!-- Not List --> 
						<div class="col-md-6 col-lg-6" ng-if="!expp.choiceInList">	
							
							
							<div  ng-if="doneAndRecorded==false">
								
								<!-- Date -->
								<input ng-if="expp.valueType == 'java.util.Date'" class="form-control" type="text" class="input-small"
									ng-readonly="!experiment.experimentInformation.enabled"
									ng-disabled="!experiment.experimentInformation.enabled"
									placeholder="@Messages("date.format.french")" 
									ng-model="experiment.value.experimentProperties[expp.code].value" date-timestamp />
								
								
								<!-- Others -->	
								<input ng-if="expp.valueType != 'java.util.Date' && expp.valueType != 'java.io.File'" class="form-control" type="text" class="input-small"
									ng-readonly="!experiment.experimentInformation.enabled" ng-disabled="!experiment.experimentInformation.enabled"
									ng-model="experiment.value.experimentProperties[expp.code].value"/>
								
						
							</div>
							
							<div  ng-if="doneAndRecorded==true">
							
								<!-- Date -->
								<p ng-if="expp.valueType == 'java.util.Date'" class="form-control-static" ng-model="experiment.value.experimentProperties[expp.code].value" date-timestamp>
									{{experiment.value.experimentProperties[expp.code].value | date:'dd-MM-yyyy'}}
								</p>
								
								<!-- Others -->
								<p ng-if="expp.valueType != 'java.util.Date' && expp.valueType != 'java.io.File'" class="form-control-static" ng-model="experiment.value.experimentProperties[expp.code].value">
									{{experiment.value.experimentProperties[expp.code].value}}
								</p>
								
							</div>
							
						</div>
						
						<!--  File -->
						<div  ng-if="expp.valueType == 'java.io.File'">
							<input type="file" ng-disabled="!experiment.experimentInformation.enabled" base64-file="experiment.value.experimentProperties[expp.code]"  ng-show="experiment.value.experimentProperties[expp.code] == undefined || experiment.value.experimentProperties[expp.code].value == ''" />
							<div   ng-show="experiment.value.experimentProperties[expp.code] != undefined && experiment.value.experimentProperties[expp.code].value != ''" >
							    <a target="_blank" ng-href="data:application/pdf;base64,{{experiment.value.experimentProperties[expp.code].value}}">
							    {{experiment.value.experimentProperties[expp.code].fullname}}
								</a>
							</div>
							<button class="btn pull-left"  ng-show="experiment.value.experimentProperties[expp.code] != undefined && experiment.value.experimentProperties[expp.code].value != ''" ng-click="experiment.value.experimentProperties[expp.code] = undefined" ng-show="experiment.value.experimentProperties[expp.code].value != ''"><i class="fa fa-trash-o"></i></button>	
						</div>
						
						<!-- List  -->
						
						<div bt-select class="form-control"
									ng-readonly="!experiment.experimentInformation.enabled"
									ng-disabled="!experiment.experimentInformation.enabled" 
									ng-model="experiment.value.experimentProperties[expp.code].value" 
									ng-if="expp.choiceInList" 
									auto-select
									bt-options="possibleValues.code as possibleValues.name for possibleValues in expp.possibleValues" ng-edit="!doneAndRecorded">
						</div>
							   
					<!-- 	
						<div class="col-md-6 col-lg-6" ng-switch on="expp.choiceInList">
						
						<p ng-if="doneAndRecorded==true && expp.valueType == 'java.util.Date' && !experiment.experimentInformation.enabled" ng-switch-when="false" class="form-control-static" ng-model="experiment.value.experimentProperties[expp.code].value" date-timestamp>
						{{experiment.value.experimentProperties[expp.code].value | date:'dd-MM-yyyy'}}
						</p>
						
						<p ng-if="doneAndRecorded==true && expp.valueType != 'java.util.Date' && !experiment.experimentInformation.enabled" ng-switch-when="false" class="form-control-static" ng-model="experiment.value.experimentProperties[expp.code].value">
						{{experiment.value.experimentProperties[expp.code].value}}
						</p>
						
							<input ng-if="(doneAndRecorded==false || experiment.experimentInformation.enabled) && expp.valueType != 'java.util.Date'" class="form-control" type="text" ng-switch-when="false" class="input-small"
								ng-readonly="!experiment.experimentInformation.enabled" ng-disabled="!experiment.experimentInformation.enabled"
								ng-model="experiment.value.experimentProperties[expp.code].value"/>
								
							<input ng-if="(doneAndRecorded==false || experiment.experimentInformation.enabled)  && expp.valueType == 'java.util.Date' " class="form-control" type="text" ng-switch-when="false" class="input-small"
								ng-readonly="!experiment.experimentInformation.enabled" ng-disabled="!experiment.experimentInformation.enabled"
								placeholder="@Messages("date.format.french")" 
								ng-model="experiment.value.experimentProperties[expp.code].value" date-timestamp />
								
							<div bt-select class="form-control"
									ng-readonly="!experiment.experimentInformation.enabled"
									ng-disabled="!experiment.experimentInformation.enabled" 
									ng-model="experiment.value.experimentProperties[expp.code].value" 
									ng-switch-when="true" 
									auto-select
									bt-options="possibleValues.code as possibleValues.name for possibleValues in expp.possibleValues" ng-edit="!doneAndRecorded">
							   </div>
					 							
						</div>-->
					</div>							
					<!--  -->													
			    </form>
			  </div>
			</div>
		
			</div>
			<div class="col-md-5 col-lg-5">
				<div class="panel panel-default">
			  	<div class="panel-heading">
			  	<div class="btn-group pull-right" ng-switch on="experiment.instrumentInformation.enabled" ng-if="doneAndRecorded==false">
						<button class="btn btn-default btn-xs" ng-click="experiment.instrumentInformation.toggleEdit();experiment.instrumentProperties.toggleEdit()" ng-switch-when="false" data-toggle="tooltip" title="@Messages("experiments.edit")"><i class="fa fa-edit"></i></button>
						<button class="btn btn-default btn-xs" ng-click="experiment.instrumentInformation.toggleEdit();experiment.instrumentProperties.toggleEdit()" ng-switch-when="true" data-toggle="tooltip" title="@Messages("experiments.unedit")"><i class="fa fa-undo"></i></button>	
				  </div>
				  <h2 class="panel-title">Instrument</h2>			  	
			  </div>
			  <div class="panel-body">
			    <form class="form-horizontal">
			    
			    @columnLabelValue(Messages("experiments.intrumentUsedType")){
					<div ng-switch on="doneAndRecorded">						
						<p ng-switch-when="true" class="form-control-static" ng-model='experiment.value.instrument.typeCode'>
						 {{experiment.value.instrument.typeCode | codes:'type'}} </p>
						<div ng-switch-when="false">					
					<div  bt-select  class="form-control"
					ng-change="getInstrumentsTrigger()"
					ng-model="experiment.value.instrument.typeCode"
					auto-select
					ng-readonly="!experiment.instrumentInformation.enabled"
					bt-options="instrumentUsedType.code as instrumentUsedType.name for instrumentUsedType in lists.get('instrumentUsedTypes')"
					ng-disabled="!experiment.instrumentInformation.enabled">
						<option value="">@Messages("experiments.select.intrumentUsedType")</option>
					</div>
					</div>
					</div>
					
				}
			     
			     @columnLabelValue(Messages("experiments.intrument")){
			     	<div ng-switch on="doneAndRecorded">						
						<p ng-switch-when="true" class="form-control-static" ng-model='experiment.value.instrument.code'>
						 {{experiment.value.instrument.code| codes:'instrument'}} </p>
						<div ng-switch-when="false">
			     	
			     	<div  bt-select class="form-control"
											ng-model="experiment.value.instrument.code"
											ng-readonly="!experiment.instrumentInformation.enabled"
											bt-options="instrumentInformation.code as instrumentInformation.name for instrumentInformation in lists.get('instruments')"
											ng-disabled="!experiment.instrumentInformation.enabled"
											ng-hide="!experiment.value.instrument.typeCode"
											ng-change="getInputTemplate()"
											auto-select
											placeholder='@Messages("experiments.select.instrument")'
											>
					</div>
					</div>
					</div>
			     }			     

				<div class="form-group" ng-hide="!experiment.value.instrument.typeCode || experiment.outputVoid">
					<label class="col-md-6 col-lg-6 control-label">@Messages("experiments.intrumentCategory")</label>
					<div class="col-md-6 col-lg-6">
					<div ng-switch on="doneAndRecorded">						
						<p ng-switch-when="true" class="form-control-static" ng-model='experiment.value.instrument.outContainerSupportCategoryCode'>
						 {{experiment.value.instrument.outContainerSupportCategoryCode | codes:'container_support_cat'}} </p>
						<div ng-switch-when="false">					
									<div bt-select  class="form-control"
									auto-select
									ng-model="experiment.value.instrument.outContainerSupportCategoryCode"
									ng-readonly="!experiment.instrumentInformation.enabled"
									ng-change="getTemplate()"
									bt-options="instrumentCategory.code as instrumentCategory.name for instrumentCategory in lists.get('containerSupportCategories')"
									ng-disabled="!experiment.instrumentInformation.enabled"
									ng-hide="!experiment.value.instrument.typeCode || experiment.outputVoid"
									placeholder='@Messages("experiments.select.outContainerSupportCategoryCode")'>
									</div>
									</div>
									</div>
					</div>
				</div>	 	
			    
			   <div class="form-group" ng-repeat="instp in experiment.instrumentProperties.inputs | orderBy : 'displayOrder'"  ng-if="getLevel(instp.levels,'Instrument')">
								
						<label  class="col-md-6 col-lg-6 control-label" ng-if="instp.displayMeasureValue==undefined">{{instp.name}}</label>
						<label  class="col-md-6 col-lg-6 control-label" ng-if="instp.displayMeasureValue!=undefined">{{instp.name}} ({{instp.displayMeasureValue.value}})</label>
						<div class="col-md-6 col-lg-6" ng-if="instp.valueType == 'java.awt.Image'">
							<input type="file" ng-disabled="!experiment.instrumentInformation.enabled" base64-img="experiment.value.instrumentProperties[instp.code]" />
							<div ng-click="setImage(experiment.value.instrumentProperties[instp.code].value,experiment.value.instrumentProperties[instp.code].fullname,experiment.value.instrumentProperties[instp.code].width,
							    experiment.value.instrumentProperties[instp.code].height)" class="thumbnail col-md-6 col-lg-6"  ng-show="experiment.value.instrumentProperties[instp.code] != undefined && experiment.value.instrumentProperties[instp.code].value != ''" >
								
								 <div data-target="#modalImage" role="button" data-toggle="modal" >
							     <a href="#">
								<img  src="data:image/{{experiment.value.instrumentProperties[instp.code].extension}};base64,{{experiment.value.instrumentProperties[instp.code].value}}">
								</a>
									
								</div>
							</div>
							<button class="btn pull-left"  ng-show="experiment.value.instrumentProperties[instp.code] != undefined && experiment.value.instrumentProperties[instp.code].value != ''" ng-click="experiment.value.instrumentProperties[instp.code] = undefined" ng-show="experiment.value.instrumentProperties[instp.code].value != ''"><i class="fa fa-trash-o"></i></button>	
						</div>
						<div ng-if="instp.valueType != 'java.awt.Image'">
						<div ng-switch on="doneAndRecorded">						
						<p ng-switch-when="true" class="form-control-static col-md-6 col-lg-6" ng-model='experiment.value.instrumentProperties[instp.code].value'>
						 {{experiment.value.instrumentProperties[instp.code].value}} </p>
						 
						<div ng-switch-when="false">	
						
							<div class="col-md-6 col-lg-6" ng-switch on="instp.choiceInList">
								<input class="form-control" type="text" title='{{instp.name}}' ng-switch-when="false" class="input-small"
									ng-readonly="!experiment.instrumentInformation.enabled"
									ng-model="experiment.value.instrumentProperties[instp.code].value"
									ng-disabled="!experiment.instrumentInformation.enabled"
									udt-default-value="instp.defaultValue"/>
								
								<div bt-select class="form-control" bt-options="opt.value as opt.value for opt in instp.possibleValues" udt-default-value="instp.defaultValue"
									ng-readonly="!experiment.instrumentInformation.enabled" ng-disabled="!experiment.instrumentInformation.enabled" 
									ng-model="experiment.value.instrumentProperties[instp.code].value" ng-switch-when="true" 
									auto-select>
							    </div>
							</div>
							</div>
							</div>
							
						</div>
				</div>	
																												    
			    </form>
			    </div>
			    </div>
		
			</div>
			<div class="col-md-2 col-lg-2">
				<div class="panel panel-default">
				  <div class="panel-heading">			  
				  <h2 class="panel-title">Info</h2>			  	
				  </div>
				  <div class="panel-body">
				  
				    <form class="form-horizontal">
				    @columnLabelValue(Messages("experiments.creationDate")){
						<p class="form-control-static">{{experiment.value.traceInformation.creationDate | date:'dd-MM-yyyy HH:mm:ss'}}</p>
					}
				    @columnLabelValue(Messages("experiments.createUser")){
						<p class="form-control-static">{{experiment.value.traceInformation.createUser}}</p>
					}
				   	@columnLabelValue(Messages("experiments.modifyDate")){
						<p class="form-control-static">{{experiment.value.traceInformation.modifyDate | date:'dd-MM-yyyy HH:mm:ss'}}</p>
					}	
				    @columnLabelValue(Messages("experiments.modifyBy")){
						<p class="form-control-static">{{experiment.value.traceInformation.modifyUser}}</p>
					}
				   			    								
					</form>
				  </div>
				</div>
			</div>
			
		</div>	
			  
			
		
		
		</div>
</div>
<div class="row">
<div class="col-md-12 col-lg-12">

    <div ng-include="experiment.inputTemplate"></div>
 
</div>
</div>

@reagentsSection()
@commentSection(currentUser)